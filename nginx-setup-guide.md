
# Инструкция по настройке Nginx для Yandex Direct Dashboard

## Решение проблем с SSH-подключением

Если вы видите ошибку `Handshake failed: signature verification failed` при выполнении команд на сервере, или сообщение о том, что не удалось установить SSH-соединение, проверьте следующее:

### 1. Проверка наличия и создание SSH-ключей

Если у вас нет SSH-ключей или они некорректны, создайте новую пару ключей:

```bash
# Проверка наличия существующих ключей
ls -la ~/.ssh/

# Создание новой пары ключей (если существующие некорректны)
ssh-keygen -t rsa -b 4096 -f ~/.ssh/id_rsa -N ""

# Проверка созданных ключей
ls -la ~/.ssh/
```

### 2. Настройка прав доступа для SSH-ключей

SSH-ключи должны иметь правильные права доступа:
- `~/.ssh/` директория: 700 (drwx------)
- `~/.ssh/id_rsa` (приватный ключ): 600 (-rw-------)
- `~/.ssh/id_rsa.pub` (публичный ключ): 644 (-rw-r--r--)
- `~/.ssh/authorized_keys`: 600 (-rw-------)

Установите правильные права доступа:

```bash
# Настройка прав доступа
chmod 700 ~/.ssh/
chmod 600 ~/.ssh/id_rsa
chmod 644 ~/.ssh/id_rsa.pub
chmod 600 ~/.ssh/authorized_keys
```

### 3. Проверка формата SSH-ключа

Если ключ был создан в неверном формате, проверьте и при необходимости конвертируйте его:

```bash
# Проверка формата ключа
ssh-keygen -l -f ~/.ssh/id_rsa

# Если требуется конвертация из PEM в OpenSSH формат
ssh-keygen -p -m PEM -f ~/.ssh/id_rsa
```

### 4. Обновление authorized_keys

Убедитесь, что публичный ключ добавлен в файл authorized_keys:

```bash
# Создание файла authorized_keys, если его нет
touch ~/.ssh/authorized_keys

# Добавление публичного ключа в authorized_keys
cat ~/.ssh/id_rsa.pub >> ~/.ssh/authorized_keys

# Установка правильных прав доступа
chmod 600 ~/.ssh/authorized_keys
```

### 5. Проверка SSH-подключения

После настройки SSH-ключей проверьте подключение:

```bash
# Простая команда для проверки подключения
echo "Тест SSH-подключения"
```

Если вы видите вывод "Тест SSH-подключения", значит SSH-подключение работает корректно.

## Проверка и исправление проблем с символическими ссылками

Если вы видите ошибку `Too many levels of symbolic links` при проверке конфигурации Nginx, выполните следующие команды:

```bash
# Проверьте содержимое директории sites-enabled
sudo ls -la /etc/nginx/sites-enabled/

# Если есть неправильные символические ссылки (например, "ln"), удалите их:
sudo rm /etc/nginx/sites-enabled/ln

# Если есть другие проблемные ссылки, их тоже нужно удалить
```

## Правильная установка конфигурации Nginx

1. Скопируйте файл настроек в правильное местоположение:

```bash
sudo cp nginx-config-example.txt /etc/nginx/sites-available/yandex-dashboard
```

2. Создайте символическую ссылку в sites-enabled:

```bash
sudo rm -f /etc/nginx/sites-enabled/yandex-dashboard
sudo ln -s /etc/nginx/sites-available/yandex-dashboard /etc/nginx/sites-enabled/
```

3. Проверьте, что нет конфликтующих конфигураций:

```bash
# Если у вас есть default конфигурация и она конфликтует с вашим приложением, вы можете её отключить:
sudo rm /etc/nginx/sites-enabled/default
```

4. Проверьте конфигурацию Nginx:

```bash
sudo nginx -t
```

5. Если всё в порядке, перезапустите Nginx:

```bash
sudo systemctl restart nginx
```

## Структура конфигурации Nginx

Важно помнить, что директивы `server` всегда должны находиться внутри блока `http {}` в основном файле `/etc/nginx/nginx.conf`.

Однако, для удобства администрирования, обычно конфигурации отдельных сайтов хранятся в директории `/etc/nginx/sites-available/` и активируются через символические ссылки в `/etc/nginx/sites-enabled/`.

## Проверка настройки SSL

После настройки, убедитесь что SSL сертификаты корректно настроены:

```bash
curl -I https://allynovaittest.site
```

Вы должны получить ответ с кодом 200 OK.

